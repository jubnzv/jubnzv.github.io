<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><style type=text/css>body{font-family:monospace}</style><title>Creating CI pipelines for C++/Qt applications with Buildbot</title><link rel=stylesheet href=/css/style.css></head><body><header>==========<br>== <a href=https://jubnzv.github.io/>Idie</a> ==<br>==========<div style=float:right></div><br><p><nav><a href=/><b>Start</b></a>.
<a href=/><b>Home</b></a>.
<a href=/posts><b>All posts</b></a>.
<a href=/about><b>About</b></a>.
<a href=/tags><b>Tags</b></a>.</nav></p></header><main><article><h1>Creating CI pipelines for C++/Qt applications with Buildbot</h1><b><time>2021-01-18 09:23:31</time></b>
<a href=/tags/ci>ci</a>
<a href=/tags/buildbot>buildbot</a><div><h2 id=introduction>Introduction</h2><p>I recently had to set up a Continuous Integration (CI) system to automate the build and testing of several proprietary C++ project based on Qt. I needed a self-hosted solution that works on a local network, and is as customizable and flexible as possible. Among other alternatives, I chose <a href=https://buildbot.net/>Buildbot</a>.</p><p>Buildbot is a Python framework for creating CI.
The task was not so simple, as there are very few tutorials on installing and configuring Buildbot. So I wrote this small article. It gives a very cursory overview of the framework and provides practical step-by-step guide to create your own configuration for Qt project. I assume that you are already familiar with Buildbot, otherwise you&rsquo;ll need to read <a href=https://docs.buildbot.net/>the official documentation</a> while reading this article.</p><p>There won&rsquo;t be a full configuration and demo project here, because it depends on your project and your local area network infrastructure.
However, using this guide, you can set up your own CI pipeline without reading all the documentation.</p><p>In the first part we&rsquo;ll configure CI server and install the necessary components.
Next we&rsquo;ll take a closer look at the pipeline configuration process and create a very simple config.</p><p>As a result, we will get a CI that provides:</p><ul><li>build of the application with dependent components using different versions of Qt and toolchains</li><li>extensibility and flexible configuration: the resulting system can be easily extended by running static analyzers, launching unit tests, etc.</li><li>functioning withing a local network without external dependencies</li></ul><p>To install, we&rsquo;ll need a Linux server connected to Internet. I&rsquo;ll use Debian 10 in this article.
I also assume that you are using git as version control system, however, the configuration for other VCS will not be much different.</p><h2 id=preparing-the-server>Preparing the server</h2><p>We will install the Buildbot on the latest Debian Buster 10. For other distributions, the differences will only be the commands associated with using the package manager.</p><p>At the time of writing the actual version of Buildbot is 2.10.</p><p>For the demonstration we will deploy both Buildbot master and Buildbot worker on the same machine.
For a real system you&rsquo;ll probably want to use multiple workers on separate servers. This allows you to speed up the CI process and use different operating systems or environment settings for workers. This can be easily achieved because the configuration of the workers will be actually the same.</p><h3 id=installing-the-master>Installing the Master</h3><p>Let&rsquo;s start by installing Buildbot master. Buildbot master is a daemon that runs a web server that allows the end user to start new builds and to control the behavior of the Buildbot instance. The master also distributes builds to the workers.</p><p>First we need to install the required system packages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y python3 python3-pip
</span></span></code></pre></div><p>Next, we will install the Buildbot components. We will use the <code>pip</code> package manager to get a more recent version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install Buildbot<span style=color:#f92672>[</span>all<span style=color:#f92672>]</span> Buildbot-waterfall-view Buildbot-www
</span></span></code></pre></div><p>We need to create a user from which the build process will be performed. We also want to add him in the required groups:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>useradd buildbot
</span></span><span style=display:flex><span>sudo usermod -aG docker buildbot
</span></span><span style=display:flex><span>sudo su buildbot
</span></span></code></pre></div><p>Now create a master:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /home/buildbot
</span></span><span style=display:flex><span>buildbot create-master master
</span></span></code></pre></div><p>At this point, we will stop and configure worker on the same server. We will return to the master in a separate section.</p><h3 id=installing-a-worker>Installing a Worker</h3><p>A worker is a daemon that connects to the master daemon and performs builds whenever master tells him to do so.</p><p>First install the system packages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y ssh git python3 python3-pip
</span></span></code></pre></div><p>Then install the Buildbot components:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install buildbot-worker
</span></span></code></pre></div><p>We will also need to create a <a href=https://docs.Buildbot.net/latest/manual/secretsmanagement.html>secrets</a> file to keep the new worker&rsquo;s password:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /home/buildbot/secrets/
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;password-1234&#39;</span> &gt; /home/buildbot/secrets/local-worker-password
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>700</span> /srv/buildbot/secrets/local-worker-password
</span></span></code></pre></div><p>Finally, we can create a worker:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /home/buildbot/
</span></span><span style=display:flex><span>Buildbot-worker create-worker worker localhost local-worker <span style=color:#e6db74>&#39;password-1234&#39;</span>
</span></span></code></pre></div><p>Write the IP address and port of the Buildbot master in <code>worker/buildbot.tac</code>:</p><pre tabindex=0><code>buildmaster_host = &#39;localhost&#39;
port = 9995
</code></pre><p>Now let&rsquo;s prepare the docker images needed in our CI pipeline.</p><h4 id=preparing-docker-images-for-qt-builds>Preparing docker images for Qt builds</h4><p>Most code bases eventually migrate to new versions of the frameworks, being compiled by later versions of toolchains. You will probably also have to support building your application for multiple platforms, which is typical for embedded systems. This complicates our task a bit. Now we also want to build our project in multiple build environments to make sure that the new changes don&rsquo;t break backward compatibility on some platforms. To achieve this we will use docker.</p><p>Fortunately, there is a set of Dockerfile&rsquo;s <a href=https://github.com/rabits/dockerfiles>rabits/dockerfiles</a> that contain a development environment with different versions of Qt.
This will make our task easier.
We will only need to download docker images with the required versions of Qt and add toolchain and additional dependencies needed to build our project.</p><p>Let&rsquo;s look at an example. We will create a sample Dockerfile with the <code>clang++</code> compiler from the Ubuntu package repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> rabits/qt:5.13-desktop</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Install the required dependencies. Replace with your own components.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span>           <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y clang++<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>When you&rsquo;re done writing your Dockerfile, start building a new image and tag it with a unique name:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t <span style=color:#e6db74>&#39;demo-project:qt-5.13-clang&#39;</span> .
</span></span></code></pre></div><p>Create docker images for all the required build environments and proceed to the next step.</p><h3 id=configuring-systemd>Configuring systemd</h3><p>We also want to start a master and workers on a boot time. For this, we&rsquo;ll create systemd unit files so that the server&rsquo;s init system can manage the Buildbot processes.</p><p>First, we&rsquo;ll create and open a file named <code>/etc/systemd/system/buildbot-master.service</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Buildbot Master</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span><span style=color:#f92672>=</span><span style=color:#e6db74>network.target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>network.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>Buildbot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Group</span><span style=color:#f92672>=</span><span style=color:#e6db74>Buildbot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WorkingDirectory</span><span style=color:#f92672>=</span><span style=color:#e6db74>/home/buildbot/master/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/buildbot start --nodaemon</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecReload</span><span style=color:#f92672>=</span><span style=color:#e6db74>/bin/kill -HUP $MAINPID</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>always</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>Buildbot</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span></code></pre></div><p>Next, we&rsquo;ll create <code>/etc/systemd/system/buildbot-worker.service</code> for the worker:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>Buildbot Worker</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Wants</span><span style=color:#f92672>=</span><span style=color:#e6db74>network.target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>network.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>Buildbot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Group</span><span style=color:#f92672>=</span><span style=color:#e6db74>Buildbot</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WorkingDirectory</span><span style=color:#f92672>=</span><span style=color:#e6db74>/home/buildbot/worker</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/buildbot-worker start --nodaemon</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>always</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>Buildbot</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span></code></pre></div><p>Then reload systemd and add our services to autostart:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl enable --now Buildbot-worker
</span></span><span style=display:flex><span>systemctl enable --now Buildbot-master
</span></span></code></pre></div><h2 id=setting-up-a-ci-pipeline>Setting up a CI pipeline</h2><p>Now let&rsquo;s move on to configuring the CI pipeline on the Buildbot master side.
First we&rsquo;ll copy sample <code>master.cfg.sample</code> config to <code>master.cfg</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp -v /home/buildot/master/master.cfg<span style=color:#f92672>{</span>.sample,<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Then, we&rsquo;ll work with <code>/home/buildot/master/master.cfg</code> that is a long Python script.
Open it with <a href=www.vim.org>your favorite text editor</a> and proceed to the next section.</p><h3 id=general-settings>General settings</h3><p>First, we&rsquo;ll need to set up general settings with information about our environment. Add the appropriate URLs to your CI server and VCS web interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>c <span style=color:#f92672>=</span> BuildmasterConfig <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;title&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Demo Project&#34;</span>
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;titleURL&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://git-server/demo-user/demo-project/&#34;</span>
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;BuildbotURL&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://buildbot-server:8010/&#34;</span>
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;www&#34;</span>] <span style=color:#f92672>=</span> dict(port<span style=color:#f92672>=</span><span style=color:#ae81ff>8010</span>, plugins<span style=color:#f92672>=</span>dict(
</span></span><span style=display:flex><span>    waterfall_view<span style=color:#f92672>=</span>{},
</span></span><span style=display:flex><span>    console_view<span style=color:#f92672>=</span>{},
</span></span><span style=display:flex><span>    grid_view<span style=color:#f92672>=</span>{}))
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;db&#34;</span>] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;db_url&#34;</span>: <span style=color:#e6db74>&#34;sqlite:///state.sqlite&#34;</span>}
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;secretsProviders&#34;</span>] <span style=color:#f92672>=</span> [secrets<span style=color:#f92672>.</span>SecretInAFile(dirname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/home/buildbot/secrets&#34;</span>)]
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;workers&#34;</span>] <span style=color:#f92672>=</span> [worker<span style=color:#f92672>.</span>Worker(<span style=color:#e6db74>&#34;local-worker&#34;</span>, util<span style=color:#f92672>.</span>Secret(<span style=color:#e6db74>&#34;local-worker-password&#34;</span>))]
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;protocols&#34;</span>] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;pb&#34;</span>: {<span style=color:#e6db74>&#34;port&#34;</span>: <span style=color:#ae81ff>9991</span>}}
</span></span></code></pre></div><h3 id=code-bases>Code bases</h3><p>A <a href=https://docs.buildbot.net/latest/manual/concepts.html>codebase</a> is a collection of related files and their history tracked as a unit by version control systems. The files and their history are stored in one or more repositories.</p><p>Add the necessary codebases for your projects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>all_repositories <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#39;ssh://git-server/demo-user/demo-project&#39;</span>: <span style=color:#e6db74>&#39;demo-project&#39;</span> }
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>codebaseGenerator</span>(chdict):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> all_repositories[chdict[<span style=color:#e6db74>&#39;repository&#39;</span>]]
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#39;codebaseGenerator&#39;</span>] <span style=color:#f92672>=</span> codebaseGenerator
</span></span></code></pre></div><p>You will also need to create <a href=https://docs.buildbot.net/latest/manual/configuration/changesources.html>change source</a> instances to make Buildbot know about our code bases.
Add this line in the config and proceed to the next section:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>c[<span style=color:#e6db74>&#39;change_source&#39;</span>] <span style=color:#f92672>=</span> [changes<span style=color:#f92672>.</span>GitPoller(str(url), pollinterval<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>) <span style=color:#66d9ef>for</span> url <span style=color:#f92672>in</span> all_repositories<span style=color:#f92672>.</span>keys()]
</span></span></code></pre></div><h3 id=schedulers>Schedulers</h3><p><a href=https://docs.buildbot.net/latest/manual/configuration/schedulers.html>Schedulers</a> are responsible for initiating builds on builders. They decide how to react to incoming changes in your code bases and how to start workers.</p><p>In this section we will create two schedulers: &ldquo;manual&rdquo; <a href=https://docs.buildbot.net/latest/manual/configuration/schedulers.html#forcescheduler-scheduler>ForceScheduler</a> and <a href=https://docs.buildbot.net/latest/manual/configuration/schedulers.html#singlebranchscheduler>SingleBranchScheduler</a> that reacts on new commits in the <code>master</code>.</p><p>First, let&rsquo;s create <code>ForceScheduler</code> that will start build process after manual build request in the web interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>c[<span style=color:#e6db74>&#34;schedulers&#34;</span>] <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;schedulers&#34;</span>]<span style=color:#f92672>.</span>append(schedulers<span style=color:#f92672>.</span>ForceScheduler(
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;forced-scheduler&#34;</span>,
</span></span><span style=display:flex><span>    properties<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>            util<span style=color:#f92672>.</span>StringParameter(
</span></span><span style=display:flex><span>                name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;buildname&#39;</span>,
</span></span><span style=display:flex><span>                label<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Build Name:&#39;</span>,
</span></span><span style=display:flex><span>                required<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>,
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    codebases<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>        forcesched<span style=color:#f92672>.</span>CodebaseParameter(
</span></span><span style=display:flex><span>            codebase<span style=color:#f92672>=</span>name,
</span></span><span style=display:flex><span>            branch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;master&#34;</span>,
</span></span><span style=display:flex><span>            repository<span style=color:#f92672>=</span>forcesched<span style=color:#f92672>.</span>FixedParameter(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;repository&#34;</span>, default<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>, hide<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>),
</span></span><span style=display:flex><span>            project<span style=color:#f92672>=</span>forcesched<span style=color:#f92672>.</span>FixedParameter(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;project&#34;</span>, default<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>, hide<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>),
</span></span><span style=display:flex><span>            revision<span style=color:#f92672>=</span>forcesched<span style=color:#f92672>.</span>FixedParameter(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;revision&#34;</span>, default<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>, hide<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>),
</span></span><span style=display:flex><span>        ) <span style=color:#66d9ef>for</span> name <span style=color:#f92672>in</span> [<span style=color:#e6db74>&#34;demo-project&#34;</span>]
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    builderNames<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;local-builder&#34;</span>]))
</span></span></code></pre></div><p>Next we&rsquo;ll add a <code>SingleBranchScheduler</code> for the <code>master</code> branch:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Branch schedulers that watch over changes in projects.</span>
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;schedulers&#34;</span>]<span style=color:#f92672>.</span>append(schedulers<span style=color:#f92672>.</span>SingleBranchScheduler(
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;changes-scheduler&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e># The scheduler will wait for this many seconds before starting the build.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If new changes are made during this interval, the timer will be restarted.</span>
</span></span><span style=display:flex><span>    treeStableTimer<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>,
</span></span><span style=display:flex><span>    change_filter<span style=color:#f92672>=</span>util<span style=color:#f92672>.</span>ChangeFilter(branch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;master&#34;</span>),
</span></span><span style=display:flex><span>    codebases<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;demo-project&#34;</span>],
</span></span><span style=display:flex><span>    builderNames<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;local-builder&#34;</span>]))
</span></span></code></pre></div><p>After that, we can describe the commands included in our pipeline.</p><h3 id=build-steps>Build steps</h3><p>Buildbot performs commands execution in the pipeline via <a href=https://docs.buildbot.net/latest/manual/concepts.html#concepts-builder>Builders</a>.</p><p>We&rsquo;ll create a builder for our worker:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>c[<span style=color:#e6db74>&#34;builders&#34;</span>] <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>test_factory <span style=color:#f92672>=</span> util<span style=color:#f92672>.</span>BuildFactory()
</span></span><span style=display:flex><span>c[<span style=color:#e6db74>&#34;builders&#34;</span>]<span style=color:#f92672>.</span>append(util<span style=color:#f92672>.</span>BuilderConfig(
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;local-builder&#34;</span>,
</span></span><span style=display:flex><span>    workernames<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;local-worker&#34;</span>],
</span></span><span style=display:flex><span>    factory<span style=color:#f92672>=</span>test_factory))
</span></span></code></pre></div><p>Next let&rsquo;s add some pipeline commands to the created builder.</p><p>First, we&rsquo;ll need to clone Git repository with our codebase. Add the following configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>test_factory<span style=color:#f92672>.</span>addStep(steps<span style=color:#f92672>.</span>Git(
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;git clone&#34;</span>,
</span></span><span style=display:flex><span>    repourl<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ssh://local-git/demo-user/demo-project&#34;</span>,
</span></span><span style=display:flex><span>    alwaysUseLatest<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>    method<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;copy&#34;</span>,
</span></span><span style=display:flex><span>    mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;full&#34;</span>,
</span></span><span style=display:flex><span>    codebase<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;demo-project&#34;</span>,
</span></span><span style=display:flex><span>    branch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;master&#34;</span>))
</span></span></code></pre></div><p>By default, Buildbot worker will create <code>/home/buildbot/worker/local-builder/build/</code> directory and clone the repository there.</p><p>Next, let&rsquo;s add a step to build our application in the docker container created earlier:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>docker_command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>docker run --privileged --rm -i                    </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>--mount &#34;type=bind,src=</span><span style=color:#e6db74>%(src_workdir)s</span><span style=color:#e6db74>,dst=/build&#34; </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>--workdir=/build/build                             </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>--user &#34;$(id -u):$(id -g)&#34;                         </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>%(container_name)s</span><span style=color:#e6db74>                                 </span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>/bin/bash -c &#34;qmake &amp;&amp; make -j`nproc`&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_factory<span style=color:#f92672>.</span>addStep(steps<span style=color:#f92672>.</span>ShellCommand(
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Qt 5.13 build&#34;</span>,
</span></span><span style=display:flex><span>    command<span style=color:#f92672>=</span>docker_command <span style=color:#f92672>%</span> {<span style=color:#e6db74>&#34;src_workdir&#34;</span>: os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;/home/buildbot/worker/local-builder/&#34;</span>),
</span></span><span style=display:flex><span>                              <span style=color:#e6db74>&#34;container_name&#34;</span>: <span style=color:#e6db74>&#34;demo-project:qt-5.13-clang&#34;</span>}))
</span></span><span style=display:flex><span><span style=color:#75715e># ... add the same steps for other containers</span>
</span></span></code></pre></div><p>The <code>docker_command</code> present here is a bit tricky. <code>â€“user "$(id -u):$(id -g)"</code> tells the container to run with the current user id and group id which are obtained dynamically through bash command substitution by running the <code>id -u</code> and <code>id -g</code> and passing on their values. We need this to avoid problems with permissions, because we want to compile source to object files and save them mounted volume.</p><h2 id=testing-the-system>Testing the system</h2><p>In the end, we got a minimal CI pipeline that should work right now.</p><p>Restart master instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart buildbot-master
</span></span></code></pre></div><p>And open web interface, specified in the configuration. If all work correctly, you should see something like this:</p><p><figure><img src=/posts/qt-ci-with-buildbot/welcome-screen.png alt></figure></p><p>If the interface is not displayed, I recommend looking at the logs by this way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tail -f /home/buildbot/master/twistd.log
</span></span></code></pre></div><p>Most often, errors are well described in the logs, and you can easily find problems in your config.</p></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/posts/qt-ci-with-buildbot/>Creating CI pipelines for C++/Qt applications with Buildbot</a></li><li><a href=/posts/vim-modern-cpp/>Using (neo)vim for C++ development</a></li></ul></div></div></aside><footer><p>&copy; 2022 <a href=https://jubnzv.github.io/><b>Idie</b></a>.
<a href=mailto:jubnzv@gmail.com><b>E-mail</b></a>.
<a href=https://github.com/jubnzv><b>GitHub</b></a>.
<a href=https://linkedin.com/in/jubnzv><b>LinkedIn</b></a>.
<a href=https://t.me/jubnzv><b>Telegram</b></a>.</p></footer></body></html>